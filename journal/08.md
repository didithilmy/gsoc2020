# Project Journal Ep. 8
**Jul 20th, 2020**

## Objectives
- Out of scope, RnD activity: Find a way to integrate a storage caching layer with Rucio and the JupyterLab extension.

## Challenges
- Unfamiliar with setting up XRootD and XCache.
  - Resolved: Had a call with Riccardo to give a tutorial on how to setup the environment.
- Tried installing N2N Rucio plugin in Riccardo's XRootD Docker containers.
  - Followed steps in [https://github.com/xrootd/rucioN2N-for-Xcache/wiki/Introduction-to-Xrootd-N2N-for-Disk-Caching-Proxy-(Xcache)-utilizing-RUCIO-metalink](https://github.com/xrootd/rucioN2N-for-Xcache/wiki/Introduction-to-Xrootd-N2N-for-Disk-Caching-Proxy-(Xcache)-utilizing-RUCIO-metalink)
  - No luck, but I think the plugin is loaded, just not used. This line was present in the log: `200730 07:47:45 024 Posix_P2L: file /rucio/test:file1 pfn2lfn /atlas/rucio/test/80/25/file1`
  - But, there's no sign of an HTTP call being made to Rucio.
  - Additionally, the prefix `/atlas` and the Rucio hostname are hardcoded in the code.

## Observations
- When using `xrdfs root://cache:1094//root://origin:1094//filename.txt`, the origin part is ignored and configuration value is used instead.
  - Tried changing `origin` to something else, `ls` would still work.
  - Default value is `<I forgot the hostname>.cern.ch`, so it must be changed to use `xrdfs`.
- When using `xrdcp root://cache:1094//root://origin:1094//filename.txt`, the origin part is considered.
  - However, once successfully cached, only the filename is checked.
  - Changing the origin address after that first successful fetch won't make a difference. See [Console Output 1](#console-output-1).
    - Could be problematic, what if two files with the same path but different origin want to be fetched?
    - Resolved: this is an intended behavior as in HEP, every file must have different paths.
- When trying to connect `origin_xrootd_stable` to Rucio as an RSE
  - An RSE with the name `ORIGIN` was added to Rucio, tagged with `root-proxy-internal` attribute.
  - Error: checksum was not calculated.
    - Resolved: Added this line: `xrootd.chksum adler32 /usr/local/bin/xrdadler32.sh`.
    - Shell script `xrdadler32.sh` is procured from Rucio's XRD1 Docker container.
  - Error: checksum invalid, it says "Error accessing"
    - The shell script accepts a file path as its input. Whenever the path is incorrect, it outputs "Error accessing".
    - Observation: in XRD1 container, the physical file is placed in `/rucio/...`, which is the same as the XRD path. In `origin_xrootd_stable`, it's `/data/xrd/rucio/...`.
    - Resolved: edit shell script to include `/data/xrd/$1` as the argument.
- When trying to list file replicas
  - A file was uploaded to `ORIGIN`.
  - When listing the file replicas through CLI, it is expected that the PFN starts with the Xcache address. It didn't.
  - I looked at Rucio's source code to find out that the cache is only appended if the site name is different than the RSE's.
  - I tried to find a way how to configure the client's site name.
    - Resolved: use environment variable `SITE_NAME`
  - Still, cache URL won't be appended.
    - Resolved: Cache is specified in the config instead of RSE attribute, tied to a site name.
    - The site name specified in the client must be different than the one specified in the RSE attribute.
    - Additionally, the config item must NOT begin with `root://`.

## Results
Not yet

## Attachments
#### Console Output 1
```
# This one didn't work
[root@2d02cd2224d4 /]# xrdcp root://xcache_xrootd_stable_standalone//root://origin_xrootd_stab:1094/test test
[0B/0B][100%][==================================================][0B/s]
Run: [ERROR] Server responded with an error: [3005] Unable to open /root:/origin_xrootd_stab:1094/test; no route to host (source) 

# This one worked
[root@2d02cd2224d4 /]# xrdcp root://xcache_xrootd_stable_standalone//root://origin_xrootd_stable:1094/test test
[5B/5B][100%][==================================================][5B/s]

[root@2d02cd2224d4 /]# rm test
rm: remove regular file 'test'? y

# This shouldn't work, but it did
[root@2d02cd2224d4 /]# xrdcp root://xcache_xrootd_stable_standalone//root://origin_xrootd_stab:1094/test test
[5B/5B][100%][==================================================][5B/s]
```